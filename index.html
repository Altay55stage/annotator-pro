<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>YOLO Annotator</title>
    <!-- Optionnel: Ajouter des icônes (exemple avec Font Awesome, nécessite une configuration) -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> -->
    <style>
        :root {
            --app-bg-color: #f0f2f5; /* Fond d'application plus neutre */
            --card-bg-color: #ffffff;
            --primary-color: #007aff; /* Bleu iOS-like */
            --primary-text-color: #ffffff;
            --secondary-text-color: #8e8e93; /* Gris iOS pour texte secondaire */
            --text-color: #1c1c1e; /* Noir iOS pour texte principal */
            --border-color: #c6c6c8;
            --header-height: 50px;
            --bottom-action-bar-height: 60px;
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px); /* Pour encoche iPhone */
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Enlève le flash bleu au toucher sur mobile */
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--app-bg-color);
            color: var(--text-color);
            font-size: 16px; /* Base pour mobile */
            overflow-x: hidden; /* Empêche le scroll horizontal */
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        /* --- Header --- */
        .app-header {
            background-color: var(--card-bg-color);
            color: var(--text-color);
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            font-weight: 600;
            border-bottom: 1px solid #e0e0e0;
            position: fixed; /* Ou sticky */
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* --- Content Area --- */
        .app-content {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto; /* Scroll uniquement pour le contenu */
            -webkit-overflow-scrolling: touch; /* Scroll fluide sur iOS */
            margin-top: var(--header-height); /* Espace pour le header fixe */
            padding-bottom: calc(var(--bottom-action-bar-height) + var(--safe-area-inset-bottom) + 15px); /* Espace pour la barre d'action et l'encoche */
        }

        .card {
            background-color: var(--card-bg-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        .card-subtitle {
            font-size: 0.9em;
            color: var(--secondary-text-color);
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95em;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background-color: #f8f8f8; /* Fond leggerement different pour inputs */
            margin-bottom: 15px;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px dashed var(--primary-color);
            border-radius: 8px;
            background-color: var(--app-bg-color);
            color: var(--primary-color);
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
        }
        input[type="file"]::file-selector-button { /* Style le bouton "Parcourir" */
            display: none; /* On cache le bouton par défaut, le label fait office */
        }


        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            accent-color: var(--primary-color); /* Couleur de la coche */
        }
        .checkbox-container label {
            margin-bottom: 0;
            font-weight: normal;
        }


        #modelStatus {
            font-size: 0.9em;
            color: var(--secondary-text-color);
            text-align: center;
            padding: 5px 0;
        }

        .image-preview-container {
            width: 100%;
            min-height: 200px;
            max-height: 40vh;
            background-color: #e9ecef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }
        #uploadedImageDisplay {
            max-width: 100%;
            max-height: 100%; /* S'adapte au conteneur */
            object-fit: contain;
            display: none; /* Caché initialement */
        }
        #overlayCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        .image-placeholder-text {
            color: var(--secondary-text-color);
            font-size: 0.9em;
        }

        .log-output-card .card-title {
            margin-bottom: 8px;
        }
        pre {
            background-color: #e9ecef;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.8em;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 150px;
            overflow-y: auto;
            color: #495057;
        }

        /* --- Bottom Action Bar --- */
        .app-bottom-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg-color);
            height: calc(var(--bottom-action-bar-height) + var(--safe-area-inset-bottom));
            padding-bottom: var(--safe-area-inset-bottom);
            display: flex;
            align-items: center;
            justify-content: space-around; /* Ou space-evenly */
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -1px 5px rgba(0,0,0,0.08);
            z-index: 100;
        }

        .action-button {
            flex-grow: 1;
            padding: 10px 5px;
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            border: none;
            border-radius: 8px; /* Moins arrondi pour s'intégrer dans la barre */
            font-size: 0.95em;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            margin: 0 8px; /* Espace entre les boutons */
            height: 40px;
        }
        .action-button:disabled {
            background-color: #b0bec5; /* Gris plus clair pour désactivé */
            color: #e0e0e0;
            cursor: not-allowed;
        }
        .action-button.secondary { /* Pour un style de bouton secondaire si besoin */
            background-color: #e9ecef;
            color: var(--primary-color);
        }


        /* Accordion for advanced settings */
        details {
            background-color: var(--card-bg-color);
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        details summary {
            padding: 15px;
            font-weight: 500;
            cursor: pointer;
            list-style-position: inside; /* Pour l'indicateur */
            border-bottom: 1px solid var(--app-bg-color); /* Séparateur si ouvert */
        }
        details[open] summary {
            border-bottom: 1px solid #e0e0e0;
        }
        details .details-content {
            padding: 0 15px 15px 15px;
        }
        details summary::marker { /* Style l'indicateur (flèche) */
           color: var(--primary-color);
        }


        /* --- Responsive pour Desktop --- */
        @media (min-width: 768px) {
            body { font-size: 14px; } /* Ajuster la base de police pour desktop */
            .app-header { justify-content: flex-start; padding-left: 20px; }
            .app-content {
                max-width: 900px; /* Limite la largeur du contenu principal */
                margin: var(--header-height) auto 0 auto; /* Centre le contenu */
                padding: 20px;
                padding-bottom: 20px; /* Pas besoin de bottom-action-bar sur desktop */
            }
            .app-bottom-actions { display: none; } /* Cacher la barre d'action du bas */

            /* Afficher les boutons d'action dans le contenu principal sur desktop */
            .desktop-actions-container {
                display: flex;
                gap: 15px;
                margin-top: 20px;
            }
            .desktop-actions-container .action-button {
                margin: 0; /* Reset margin */
            }

            .main-layout-desktop {
                display: flex;
                gap: 20px;
            }
            .main-layout-desktop > .column {
                flex: 1;
            }
             .image-preview-container {
                max-height: none; /* Permettre plus de hauteur */
                min-height: 300px;
            }
            pre { max-height: 200px; }
        }

    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            YOLO Annotator
        </header>

        <main class="app-content">
            <div class="main-layout-desktop">
                <div class="column">
                    <section class="card">
                        <h2 class="card-title">1. Configuration du Modèle</h2>
                        <label for="modelSelect">Modèle YOLO :</label>
                        <select id="modelSelect"></select>
                        <button id="loadModelBtn" class="action-button" style="width:100%; margin-top:10px; margin-left:0;">Charger Modèle</button>
                        <div id="modelStatus">Aucun modèle chargé</div>
                    </section>

                    <section class="card">
                        <h2 class="card-title">2. Image à Analyser</h2>
                        <label for="imageUpload" class="file-input-label">
                            Cliquer ici pour choisir une image
                            <input type="file" id="imageUpload" accept="image/*" style="display:none;">
                            <!-- Le input file est caché, le label déclenche son clic -->
                        </label>
                         <p class="card-subtitle" id="fileNameDisplay" style="text-align:center; margin-top:5px;"></p>
                        <div class="image-preview-container">
                            <img id="uploadedImageDisplay" src="#" alt="Aperçu de l'image">
                            <canvas id="overlayCanvas"></canvas>
                            <span class="image-placeholder-text" id="imagePlaceholder">Aucune image sélectionnée</span>
                        </div>
                    </section>
                </div>

                <div class="column">
                    <details>
                        <summary>Paramètres Avancés</summary>
                        <div class="details-content">
                            <fieldset style="border:none; padding:0; margin-top:15px;">
                                <legend style="font-weight:500; margin-bottom:10px;">YOLO Standard</legend>
                                <div>
                                    <label for="confidence">Confiance (0.01-1.0):</label>
                                    <input type="number" id="confidence" value="0.3" step="0.01" min="0.01" max="1.0">
                                </div>
                                <div>
                                    <label for="imgSize">Taille Image (inférence):</label>
                                    <input type="number" id="imgSize" value="640" step="32" min="32">
                                </div>
                                <div>
                                    <label for="nmsIou">NMS IoU:</label>
                                    <input type="number" id="nmsIou" value="0.45" step="0.01" min="0.01" max="1.0">
                                </div>
                                 <div>
                                    <label for="device">Device:</label>
                                    <select id="device">
                                        <option value="cuda">CUDA (si dispo)</option>
                                        <option value="cpu">CPU</option>
                                    </select>
                                </div>
                            </fieldset>
                            <fieldset style="border:none; padding:0; margin-top:20px;">
                                <legend style="font-weight:500; margin-bottom:10px;">SAHI (Optionnel)</legend>
                                <div class="checkbox-container">
                                    <input type="checkbox" id="useSahi">
                                    <label for="useSahi">Utiliser SAHI</label>
                                </div>
                                <div class="sahi-options" style="display:none;">
                                    <label for="sahiSliceHeight">Slice Height:</label>
                                    <input type="number" id="sahiSliceHeight" value="512">
                                    <label for="sahiSliceWidth">Slice Width:</label>
                                    <input type="number" id="sahiSliceWidth" value="512">
                                    <label for="sahiOverlapHeight">Overlap Height Ratio:</label>
                                    <input type="number" id="sahiOverlapHeight" value="0.2" step="0.01" min="0" max="0.99">
                                    <label for="sahiOverlapWidth">Overlap Width Ratio:</label>
                                    <input type="number" id="sahiOverlapWidth" value="0.2" step="0.01" min="0" max="0.99">
                                </div>
                            </fieldset>
                        </div>
                    </details>

                    <section class="card log-output-card">
                        <h2 class="card-title">Journal & Statut</h2>
                        <pre id="logOutput">Prêt.</pre>
                    </section>

                    <section class="card log-output-card">
                        <h2 class="card-title">Description LLM</h2>
                        <pre id="llmDescriptionOutput"></pre>
                    </section>
                </div>
            </div>

            <!-- Actions pour Desktop (affichées via media query) -->
            <div class="desktop-actions-container">
                <button id="predictBtnDesktop" class="action-button" disabled>Lancer Analyse</button>
                <button id="describeLlmBtnDesktop" class="action-button secondary" disabled>Décrire avec LLM</button>
            </div>
        </main>

        <footer class="app-bottom-actions">
            <button id="predictBtn" class="action-button" disabled>Analyser</button>
            <button id="describeLlmBtn" class="action-button secondary" disabled>Décrire</button>
        </footer>
    </div>

    <script>
        // --- Éléments DOM ---
        const modelSelect = document.getElementById('modelSelect');
        const loadModelBtn = document.getElementById('loadModelBtn');
        const modelStatus = document.getElementById('modelStatus');
        
        const imageUploadInput = document.getElementById('imageUpload');
        const imageUploadLabel = document.querySelector('.file-input-label'); // Le label qui fait office de bouton
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const uploadedImageDisplay = document.getElementById('uploadedImageDisplay');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const ctx = overlayCanvas.getContext('2d');

        const confidenceInput = document.getElementById('confidence');
        const imgSizeInput = document.getElementById('imgSize');
        const nmsIouInput = document.getElementById('nmsIou');
        const deviceSelect = document.getElementById('device');

        const useSahiCheckbox = document.getElementById('useSahi');
        const sahiOptionsDiv = document.querySelector('.sahi-options');
        const sahiSliceHeightInput = document.getElementById('sahiSliceHeight');
        const sahiSliceWidthInput = document.getElementById('sahiSliceWidth');
        const sahiOverlapHeightInput = document.getElementById('sahiOverlapHeight');
        const sahiOverlapWidthInput = document.getElementById('sahiOverlapWidth');

        // Boutons d'action (mobile et desktop)
        const predictBtnMobile = document.getElementById('predictBtn');
        const describeLlmBtnMobile = document.getElementById('describeLlmBtn');
        const predictBtnDesktop = document.getElementById('predictBtnDesktop');
        const describeLlmBtnDesktop = document.getElementById('describeLlmBtnDesktop');
        
        const logOutput = document.getElementById('logOutput');
        const llmDescriptionOutput = document.getElementById('llmDescriptionOutput');

        const API_BASE_URL = 'https://cf57-193-55-66-31.ngrok-free.app'; // <--- METTRE À JOUR VOTRE URL NGROK ICI

        let currentImageFile = null;
        let originalImageWidth = 0;
        let originalImageHeight = 0;
        let imageDisplayWidth = 0;
        let imageDisplayHeight = 0;
        let lastDrawnBoxes = [];

        // --- Fonctions Utilitaires ---
        function logMessage(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const newLogEntry = `[${timestamp} ${type}] ${message}\n`;
            logOutput.textContent = newLogEntry + logOutput.textContent.substring(0, 5000);
            console.log(`[${type}] ${message}`);
        }

        function updateActionButtonsState() {
            const modelLoaded = modelStatus.textContent.startsWith('Modèle chargé:');
            const imageSelected = !!currentImageFile;

            const canPredict = modelLoaded && imageSelected;
            const canDescribe = imageSelected; // Décrire ne dépend que de l'image

            predictBtnMobile.disabled = !canPredict;
            predictBtnDesktop.disabled = !canPredict;
            
            describeLlmBtnMobile.disabled = !canDescribe;
            describeLlmBtnDesktop.disabled = !canDescribe;
        }

        // --- Initialisation & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchModels();
            logMessage("Interface de type application initialisée. API: " + API_BASE_URL, "SYSTEM");
            if (API_BASE_URL.includes("xxxxxxx")) {
                 logMessage("N'OUBLIEZ PAS DE METTRE À JOUR API_BASE_URL avec votre URL ngrok !", "IMPORTANT_WARNING");
            }
            updateActionButtonsState(); // État initial des boutons

            // Clic sur le label pour déclencher l'input file caché
            if(imageUploadLabel) {
                imageUploadLabel.addEventListener('click', () => imageUploadInput.click());
            }
        });

        async function fetchModels() {
            logMessage('Chargement des modèles...');
            try {
                const response = await fetch(`${API_BASE_URL}/models`, { headers: {'ngrok-skip-browser-warning': 'true'} });
                if (!response.ok) throw new Error(`Serveur: ${response.status} ${await response.text()}`);
                const models = await response.json();
                modelSelect.innerHTML = models.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
                logMessage(models.length > 0 ? `${models.length} modèles trouvés.` : 'Aucun modèle trouvé.', models.length > 0 ? 'SUCCESS' : 'WARNING');
                if (models.length === 0) modelStatus.textContent = "Aucun modèle sur serveur.";
            } catch (error) {
                logMessage(`Erreur chargement modèles: ${error.message}`, 'ERROR');
                modelStatus.textContent = "Erreur modèles.";
            }
        }

        loadModelBtn.addEventListener('click', async () => {
            const modelName = modelSelect.value;
            if (!modelName) { logMessage('Sélectionnez un modèle.', 'WARNING'); return; }
            
            logMessage(`Chargement: ${modelName}...`);
            modelStatus.textContent = `Chargement ${modelName}...`;
            loadModelBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/load_model`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ model_name: modelName })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || `Serveur: ${response.status}`);
                modelStatus.textContent = `Modèle chargé: ${modelName}`;
                logMessage(`${modelName} chargé avec succès.`, 'SUCCESS');
            } catch (error) {
                modelStatus.textContent = "Erreur chargement.";
                logMessage(`Erreur chargement ${modelName}: ${error.message}`, 'ERROR');
            } finally {
                loadModelBtn.disabled = false;
                updateActionButtonsState();
            }
        });

        imageUploadInput.addEventListener('change', (event) => {
            currentImageFile = event.target.files[0];
            if (currentImageFile) {
                fileNameDisplay.textContent = currentImageFile.name;
                imagePlaceholder.style.display = 'none';
                uploadedImageDisplay.style.display = 'block';
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImageDisplay.src = e.target.result;
                    uploadedImageDisplay.onload = () => { // Important d'attendre que l'image soit dans le DOM et dimensions connues
                        originalImageWidth = uploadedImageDisplay.naturalWidth;
                        originalImageHeight = uploadedImageDisplay.naturalHeight;
                        adjustCanvasAndDraw();
                        lastDrawnBoxes = []; // Clear previous boxes
                        logMessage(`Image "${currentImageFile.name}" chargée (${originalImageWidth}x${originalImageHeight}).`, 'INFO');
                    }
                }
                reader.readAsDataURL(currentImageFile);
            } else {
                fileNameDisplay.textContent = "";
                uploadedImageDisplay.style.display = 'none';
                imagePlaceholder.style.display = 'block';
                ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                lastDrawnBoxes = [];
            }
            updateActionButtonsState();
        });

        useSahiCheckbox.addEventListener('change', () => {
            sahiOptionsDiv.style.display = useSahiCheckbox.checked ? 'block' : 'none';
        });

        // Fonction générique pour la prédiction, appelée par les deux boutons
        async function handlePrediction() {
            if (!currentImageFile || !modelStatus.textContent.startsWith('Modèle chargé:')) {
                logMessage('Chargez modèle et image.', 'WARNING'); return;
            }
            logMessage('Analyse en cours...', 'INFO');
            predictBtnMobile.disabled = true; predictBtnDesktop.disabled = true;
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            lastDrawnBoxes = [];

            const params = {
                confidence: parseFloat(confidenceInput.value), img_size: parseInt(imgSizeInput.value),
                nms_iou: parseFloat(nmsIouInput.value), device: deviceSelect.value,
                use_sahi: useSahiCheckbox.checked, sahi_slice_height: parseInt(sahiSliceHeightInput.value),
                sahi_slice_width: parseInt(sahiSliceWidthInput.value),
                sahi_overlap_height_ratio: parseFloat(sahiOverlapHeightInput.value),
                sahi_overlap_width_ratio: parseFloat(sahiOverlapWidthInput.value),
            };
            const queryParams = new URLSearchParams(params);
            const finalPredictUrl = `${API_BASE_URL}/predict?${queryParams.toString()}`;
            const fileData = new FormData();
            fileData.append('file', currentImageFile);

            try {
                const response = await fetch(finalPredictUrl, {
                    method: 'POST', body: fileData, headers: {'ngrok-skip-browser-warning': 'true'}
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || `Serveur: ${response.status}`);
                logMessage(`Analyse: ${result.boxes.length} boîtes trouvées.`, 'SUCCESS');
                lastDrawnBoxes = result.boxes;
                drawBoundingBoxes(lastDrawnBoxes);
            } catch (error) {
                logMessage(`Erreur prédiction: ${error.message}`, 'ERROR');
            } finally {
                updateActionButtonsState(); // Réactive les boutons en fonction de l'état global
            }
        }
        predictBtnMobile.addEventListener('click', handlePrediction);
        predictBtnDesktop.addEventListener('click', handlePrediction);

        // Fonction générique pour la description LLM
        async function handleLlmDescription() {
            if (!currentImageFile) {
                 logMessage('Téléchargez une image pour la description.', 'WARNING'); return;
            }
            logMessage('Description LLM en cours...', 'INFO');
            llmDescriptionOutput.textContent = 'En cours...';
            describeLlmBtnMobile.disabled = true; describeLlmBtnDesktop.disabled = true;

            try {
                const reader = new FileReader();
                reader.readAsDataURL(currentImageFile);
                reader.onloadend = async () => {
                    const base64Image = reader.result.split(',')[1];
                    const response = await fetch(`${API_BASE_URL}/describe_llm`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                        body: JSON.stringify({ image_base64: base64Image, prompt: "Décris cette image de manière concise." })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || `Erreur LLM (${response.status})`);
                    llmDescriptionOutput.textContent = result.description;
                    logMessage('Description LLM reçue.', 'SUCCESS');
                };
                reader.onerror = () => { throw new Error('Erreur lecture fichier pour LLM.'); };
            } catch (error) {
                logMessage(`Erreur LLM: ${error.message}`, 'ERROR');
                llmDescriptionOutput.textContent = `Erreur: ${error.message}`;
            } finally {
                 updateActionButtonsState();
            }
        }
        describeLlmBtnMobile.addEventListener('click', handleLlmDescription);
        describeLlmBtnDesktop.addEventListener('click', handleLlmDescription);


        // --- Canvas & Dessin ---
        function adjustCanvasAndDraw() {
            if (!uploadedImageDisplay.complete || uploadedImageDisplay.naturalWidth === 0 || !currentImageFile) {
                // Image pas encore chargée ou dimensions non valides
                requestAnimationFrame(adjustCanvasAndDraw); // Réessayer au prochain frame
                return;
            }
            
            const previewContainer = document.querySelector('.image-preview-container');
            const containerWidth = previewContainer.clientWidth;
            const containerHeight = previewContainer.clientHeight;

            const imgAspectRatio = originalImageWidth / originalImageHeight;
            const containerAspectRatio = containerWidth / containerHeight;

            if (imgAspectRatio > containerAspectRatio) { // Image plus large que le conteneur
                imageDisplayWidth = containerWidth;
                imageDisplayHeight = containerWidth / imgAspectRatio;
            } else { // Image plus haute ou de même ratio
                imageDisplayHeight = containerHeight;
                imageDisplayWidth = containerHeight * imgAspectRatio;
            }
            
            uploadedImageDisplay.style.width = `${imageDisplayWidth}px`;
            uploadedImageDisplay.style.height = `${imageDisplayHeight}px`;

            overlayCanvas.width = imageDisplayWidth;
            overlayCanvas.height = imageDisplayHeight;
            
            // Centrer le canvas sur l'image si l'image est plus petite que le conteneur du canvas
            overlayCanvas.style.top = `${(containerHeight - imageDisplayHeight) / 2}px`;
            overlayCanvas.style.left = `${(containerWidth - imageDisplayWidth) / 2}px`;
            
            drawBoundingBoxes(lastDrawnBoxes);
        }

        function drawBoundingBoxes(boxes) {
            if (!boxes) return;
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            if (boxes.length === 0) return;

            ctx.strokeStyle = 'rgba(255, 59, 48, 0.9)'; // Rouge iOS-like avec un peu de transparence
            ctx.lineWidth = Math.max(1.5, Math.min(imageDisplayWidth, imageDisplayHeight) / 250);

            const scaleX = imageDisplayWidth / originalImageWidth;
            const scaleY = imageDisplayHeight / originalImageHeight;

            boxes.forEach(box => {
                ctx.strokeRect(box.x1 * scaleX, box.y1 * scaleY, (box.x2 - box.x1) * scaleX, (box.y2 - box.y1) * scaleY);
            });
        }
        
        window.addEventListener('resize', () => {
            if (currentImageFile) {
                adjustCanvasAndDraw();
            }
        });

    </script>
</body>
</html>
